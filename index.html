<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tirage au sort — Roue verticale</title>
  <style>
    :root{
      --bg: #0b0f1a;
      --panel: rgba(255,255,255,0.06);
      --text: #e9ecff;
      --muted: rgba(233,236,255,0.75);
      --accent: #00e5ff;
      --accent2: #ff2bd6;
      --caseA: rgba(0,229,255,0.18);
      --caseB: rgba(255,43,214,0.18);
      --border: rgba(255,255,255,0.18);

      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --wheelW: 520px;
      --wheelH: 680px;
      --rowH: 44px;
      --rowCount: 11;
    }

    html, body{
      height:100%;
      margin:0;
      font-family: var(--font);
      background: radial-gradient(1200px 700px at 50% 20%, rgba(0,229,255,0.10), transparent 60%),
                  radial-gradient(900px 600px at 70% 70%, rgba(255,43,214,0.10), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .title-right{
    width: var(--wheelW);
    max-width: 100%;
    }
    
    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 28px 16px;
      box-sizing:border-box;
    }

    .app{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap: 18px;
      justify-items:center;
    }

    .title{
      font-size: 20px;
      letter-spacing: 0.4px;
      color: var(--muted);
      text-align:center;
    }

    /* Layout : image à gauche, roue à droite */
    .stage{
      display:grid;
      grid-template-columns: auto var(--wheelW);
      gap: 18px;
      align-items: center;
      justify-items: center;
    }

    .left-art{
      height: var(--wheelH);
      display:flex;
      align-items: flex-start;
      justify-content:center;
    }

    .left-art img{
      width: auto;
      height: 100%;
      display:block;
      
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 12px 40px rgba(0,0,0,0.45);
      object-fit: contain;
    }

    .right-col{
      width: var(--wheelW);
      max-width: 100%;
      display:grid;
      gap: 14px;
      justify-items:center;
    }

    @media (max-width: 900px){
      .stage{
        grid-template-columns: 1fr;
      }
      .left-art{
        height: auto;
        justify-content: center;
      }
      .left-art img{
        height: auto;
        width: 100%;
        max-width: var(--wheelW);
      }
      .title-right{
        width: 100%;
      }
    }

    /* Cadre roue */
    .wheel-frame{
      width: var(--wheelW);
      height: var(--wheelH);
      max-width: 100%;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--border);
      box-shadow: 0 12px 40px rgba(0,0,0,0.45);
      position: relative;
      overflow:hidden;
    }

    /* Bonus "80s lights" */
    .lights{
      position:absolute;
      inset: 10px;
      border-radius: 14px;
      pointer-events:none;
      box-shadow:
        0 0 0 2px rgba(255,255,255,0.10),
        0 0 30px rgba(0,229,255,0.10),
        0 0 30px rgba(255,43,214,0.10);
    }

    .bulbs{
      position:absolute;
      inset: 8px;
      border-radius: 14px;
      pointer-events:none;
    }

    .bulb{
      position:absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.22);
      box-shadow: 0 0 12px rgba(255,255,255,0.20);
      animation: blink 1.1s infinite steps(2,end);
    }

    .bulb:nth-child(3n){ animation-duration: 0.9s; }
    .bulb:nth-child(4n){ animation-duration: 1.3s; }

    @keyframes blink{
      0%{ opacity: 0.35; filter: saturate(1); }
      50%{ opacity: 0.95; filter: saturate(1.6); }
      100%{ opacity: 0.35; filter: saturate(1); }
    }

    /* Fenêtre de la roue */
    .wheel-window{
      position:absolute;
      left: 22px;
      right: 22px;
      top: 22px;
      bottom: 22px;
      border-radius: 14px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      overflow:hidden;
    }

    /* Bande centrale (highlight) */
    .center-highlight{
      position:absolute;
      left:0; right:0;
      top: 50%;
      height: var(--rowH);
      transform: translateY(-50%);
      background: linear-gradient(90deg, rgba(0,229,255,0.14), rgba(255,43,214,0.14));
      border-top: 1px solid rgba(255,255,255,0.14);
      border-bottom: 1px solid rgba(255,255,255,0.14);
      box-shadow: inset 0 0 40px rgba(0,0,0,0.25);
      pointer-events:none;
    }
    
    /* Flèches triangulaires pointant vers le centre */
    .pointer{
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
    
      /* Triangle */
      border-top: 12px solid transparent;
      border-bottom: 12px solid transparent;
    
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.35));
      pointer-events:none;
      z-index: 9999;
    }
    
    /* Gauche : placé à gauche, pointe vers la DROITE (->) */
    .pointer.left {
      left: 4px;
      border-left: 18px solid rgba(255,255,255,0.85); /* Changé : était border-right */
      border-right: 0; 
    }
    
    /* Droite : placé à droite, pointe vers la GAUCHE (<-) */
    .pointer.right {
      right: 4px;
      border-right: 18px solid rgba(255,255,255,0.85); /* Changé : était border-left */
      border-left: 0;
    }

    
    /* Liste virtualisée */
    .reel{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .rows{
      width: 100%;
      padding: 18px 0;
      box-sizing:border-box;
      transform: translateY(0px);
      will-change: transform;
    }
    
    .row{
      height: var(--rowH);
    
      display:flex; /* met .num et .label sur une même ligne (layout horizontal) */
      align-items:center; /* aligne verticalement .num et .label au milieu de la hauteur de la ligne */
    
      justify-content:space-between; /* pousse .num complètement à gauche et .label complètement à droite (en utilisant tout l'espace disponible entre les deux) */

          /* RÉSERVE de l'espace À GAUCHE et À DROITE à l’intérieur de chaque ligne : */
      padding-left: 30px;   /* - augmente padding-left (120px) => le numéro commence plus à droite (et s’éloigne de la flèche gauche) */
      padding-right: 30px;  /* - augmente padding-right (120px) => le label finit plus à gauche (et s’éloigne de la flèche droite) */
        /* => c’est le principal levier pour “éloigner” le texte des flèches, mais ça rétrécit beaucoup la zone utile pour le label */
      
      box-sizing:border-box; /* fait que le padding est inclus dans la largeur de la ligne (évite des débordements) */
    
      font-size: 18px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      letter-spacing: 0.2px;
      user-select:none;
    }

    .row:nth-child(odd){ background: var(--caseA); }
    .row:nth-child(even){ background: var(--caseB); }

    .row .num{
      font-variant-numeric: tabular-nums;
      opacity: 0.95;
    
      width: 40px; /* LARGEUR FIXE réservée au numéro :
                      - augmente => le label est plus tronqué (moins de place pour le texte)
                      - diminue => plus de place pour le label, mais risque de numéros moins lisibles si >9999 */
    
      flex: 0 0 40px; /* empêche le bloc numéro de grandir/rétrécir :
                         - 0 (grow) => ne prend pas plus que 40px
                         - 0 (shrink) => ne se réduit pas en dessous de 40px
                         - 40px (basis) => largeur de base = 40px
                         => garantit que la place “numéro” reste stable, et que le label récupère le reste */
    
      text-align:left; /* aligne le contenu du numéro à gauche DANS son bloc de 40px :
                          - left => chiffres proches du bord gauche du bloc num
                          - right => chiffres collés à droite du bloc num (peut libérer un peu de “visuel” à gauche) */
    }

    .row .label{
      opacity: 0.9;
    
      text-align:right; /* colle le texte à droite DANS la zone label :
                           - right => le texte “vient” vers la flèche droite
                           - left => le texte “part” depuis la gauche, souvent mieux pour lisibilité
                           - center => au centre de sa zone */
    
      overflow:hidden; /* coupe tout ce qui dépasse de la zone label (nécessaire pour ellipsis) */
      text-overflow: ellipsis; /* ajoute ... quand le texte est coupé (nécessite overflow hidden + nowrap) */
      white-space: nowrap; /* force le texte sur 1 seule ligne :
                              - nowrap => 1 ligne max (plus d’ellipsis)
                              - normal => autorise retours à la ligne (si on veut 2 lignes, il faut enlever nowrap) */
    
      max-width: 100%; /* LIMITE artificielle de largeur du label (en % de la ligne) :
                         - diminue => label encore plus tronqué (moins de place)
                         - augmente / supprime => le label peut prendre plus d’espace
                         ⚠️ avec justify-content:space-between + num width fixe, ce max-width peut être contre-productif
                         et provoquer du tronquage “inutile”. C’est un levier clé à ajuster (voire à retirer). */
    
      color: var(--muted);
      font-size: 14px;
    }

    /* Contrôles */
    .controls{
      display:flex;
      width: var(--wheelW); 
      max-width: 100%;
      align-items:center;
      justify-content:center;
    }

    .controls button{
    width: 100%;            /* le bouton prend toute la largeur du conteneur */
    }

    button{
      appearance:none;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 16px;
      letter-spacing: 0.2px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.35);
      transition: transform 0.08s ease, background 0.15s ease;
    }

    button:hover{ background: rgba(255,255,255,0.11); }
    button:active{ transform: translateY(1px); }
    button:disabled{ opacity: 0.55; cursor:not-allowed; }

    .result{
      width: min(860px, 100%);
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 16px 18px;
      box-sizing:border-box;
      text-align:center;
      min-height: 82px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .result strong{ color: var(--text); }

    .small{
      display:block;
      margin-top: 4px;
      font-size: 13px;
      color: var(--muted);
    }

    .song-link{
      color: var(--text);
      text-decoration: underline;
      text-decoration-color: rgba(255,255,255,0.35);
    }
    .song-link:hover{
      text-decoration-color: rgba(255,255,255,0.75);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="app">

      <div class="stage">
        <div class="left-art">
          <img src="./Background.png" alt="Décor" />
        </div>

      <div class="right-col">
        <div class="title title-right">Votre chanson au hasard dans ma playlist — Kl00porte</div>
      
        <div class="wheel-frame" id="wheelFrame">
          <div class="lights"></div>
          <div class="bulbs" id="bulbs"></div>
      
          <div class="wheel-window">
            <div class="reel">
              <div class="rows" id="rows"></div>
            </div>
      
            <div class="center-highlight"></div>
            <div class="pointer left"></div>
            <div class="pointer right"></div>
          </div>
        </div>
      
        <div class="controls">
          <button id="spinBtn">Lancer la roue</button>
        </div>
      
        <div class="result" id="result">—</div>
      </div>

      </div>
    </div>
  </div>

  <script>
    const CONFIG = {
      N: 2000,
      SPIN_DURATION_MS: 5000,
      VISIBLE_ROWS: 11,
      ROW_HEIGHT_PX: 44,
      BASE_STEPS_MIN: 120,
      BASE_STEPS_MAX: 190,
      THEME: {
        bg: "#0b0f1a",
        text: "#e9ecff",
        muted: "rgba(233,236,255,0.75)",
        accent: "#00e5ff",
        accent2: "#ff2bd6",
        caseA: "rgba(0,229,255,0.18)",
        caseB: "rgba(255,43,214,0.18)",
        border: "rgba(255,255,255,0.18)",
        font: "system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
        wheelW: "680px",
        wheelH: "520px"
      },
      ENABLE_BULBS: true,
      BULB_COUNT: 44,
    };

    function setThemeVars() {
      const t = CONFIG.THEME;
      const r = document.documentElement.style;
      r.setProperty("--bg", t.bg);
      r.setProperty("--text", t.text);
      r.setProperty("--muted", t.muted);
      r.setProperty("--accent", t.accent);
      r.setProperty("--accent2", t.accent2);
      r.setProperty("--caseA", t.caseA);
      r.setProperty("--caseB", t.caseB);
      r.setProperty("--border", t.border);
      r.setProperty("--font", t.font);
      r.setProperty("--wheelW", t.wheelW);
      r.setProperty("--wheelH", t.wheelH);
      r.setProperty("--rowH", CONFIG.ROW_HEIGHT_PX + "px");
      r.setProperty("--rowCount", CONFIG.VISIBLE_ROWS);
    }

    function easeOutCubic(x) { return 1 - Math.pow(1 - x, 3); }
    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function secureRandomInt(maxExclusive){
      const arr = new Uint32Array(1);
      const limit = Math.floor(0xFFFFFFFF / maxExclusive) * maxExclusive;
      while(true){
        crypto.getRandomValues(arr);
        const v = arr[0];
        if(v < limit) return v % maxExclusive;
      }
    }

    function fisherYatesShuffle(a){
      for(let i=a.length-1; i>0; i--){
        const j = secureRandomInt(i+1);
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function spotifyUriToUrl(uri){
      if(!uri) return null;
      const u = String(uri).trim();
      if(u.startsWith("https://open.spotify.com/")) return u;
      const m = /^spotify:track:([A-Za-z0-9]+)$/.exec(u);
      if(m) return `https://open.spotify.com/track/$${m[1]}`;
      return null;
    }

    let SONGS = null;

    async function loadSongsIfAny(){
      try{
        const res = await fetch("./songs.json", { cache: "no-store" });
        if(!res.ok) return null;
        const data = await res.json();
        if(!Array.isArray(data) || data.length === 0) return null;
        if(typeof data[0] === "string") return data;
        if(typeof data[0] === "object" && data[0] && ("title" in data[0] || "artist" in data[0] || "uri" in data[0] || "url" in data[0])) return data;
        return null;
      } catch {
        return null;
      }
    }

    function formatSong(entry){
      if(entry == null) return null;
      if(typeof entry === "string") return entry;
      const title = entry.title ?? "Titre inconnu";
      const artist = entry.artist ? " — " + entry.artist : "";
      return title + artist;
    }

    function getSongUrl(entry){
      if(entry == null) return null;
      if(typeof entry === "string") return null;
      const candidate = entry.url ?? entry.uri ?? null;
      return spotifyUriToUrl(candidate);
    }

    // Sac sans répétition
    let bag = [];
    let bagIndex = 0;

    function refillBag(n){
      bag = Array.from({length:n}, (_,i)=>i);
      fisherYatesShuffle(bag);
      bagIndex = 0;
    }

    function drawUniqueIndex(n){
      if(bag.length !== n || bagIndex >= bag.length){
        refillBag(n);
      }
      const v = bag[bagIndex];
      bagIndex++;
      return v;
    }

    // Rendu roue virtualisée
    const rowsEl = document.getElementById("rows");
    const spinBtn = document.getElementById("spinBtn");
    const resultEl = document.getElementById("result");

    const centerSlot = Math.floor(CONFIG.VISIBLE_ROWS / 2);
    let nValue = CONFIG.N;
    let centerIndexValue = 0;
    let absoluteStep = 0;
    let isSpinning = false;

    function buildRows(){
      rowsEl.innerHTML = "";
      for(let i=0; i<CONFIG.VISIBLE_ROWS; i++){
        const row = document.createElement("div");
        row.className = "row";

        const num = document.createElement("div");
        num.className = "num";

        const label = document.createElement("div");
        label.className = "label";

        row.appendChild(num);
        row.appendChild(label);
        rowsEl.appendChild(row);
      }
    }

    function mod(a, m){
      return ((a % m) + m) % m;
    }

    function renderRows(centerIndex, fractionalOffset){
      rowsEl.style.transform = `translateY(${-fractionalOffset * CONFIG.ROW_HEIGHT_PX}px)`;
      const rowNodes = rowsEl.children;

      for(let i=0; i<rowNodes.length; i++){
        const logicalIndex = mod(centerIndex + (i - centerSlot), nValue);
        const displayNumber = logicalIndex + 1;

        const row = rowNodes[i];
        row.querySelector(".num").textContent = displayNumber;

        const label = row.querySelector(".label");
        if(SONGS){
          label.textContent = formatSong(SONGS[logicalIndex]);
        } else {
          label.textContent = "";
        }
      }
    }

    function computeTotalStepsToLandOn(targetIndex){
      const delta = mod(targetIndex - centerIndexValue, nValue);
      const baseSteps = CONFIG.BASE_STEPS_MIN + secureRandomInt(CONFIG.BASE_STEPS_MAX - CONFIG.BASE_STEPS_MIN + 1);
      const adjust = mod(delta - (baseSteps % nValue), nValue);
      return baseSteps + adjust;
    }

    async function spin(){
      if(isSpinning) return;
      isSpinning = true;
      spinBtn.disabled = true;

      const targetIndex = drawUniqueIndex(nValue);
      const totalSteps = computeTotalStepsToLandOn(targetIndex);

      const startAbsolute = absoluteStep;
      const startTime = performance.now();
      const duration = CONFIG.SPIN_DURATION_MS;

      const tick = (now) => {
        const t = clamp01((now - startTime) / duration);
        const eased = easeOutCubic(t);

        const stepsFloat = totalSteps * eased;
        const stepsInt = Math.floor(stepsFloat);
        const frac = stepsFloat - stepsInt;

        const center = mod(centerIndexValue + stepsInt, nValue);
        renderRows(center, frac);

        if(t < 1){
          requestAnimationFrame(tick);
          return;
        }

        absoluteStep = startAbsolute + totalSteps;
        centerIndexValue = mod(centerIndexValue + totalSteps, nValue);
        renderRows(centerIndexValue, 0);

        const X = centerIndexValue + 1;

        if(SONGS){
          const entry = SONGS[centerIndexValue];
          const songText = formatSong(entry);
          const songUrl = getSongUrl(entry);

          if(songText && songUrl){
            resultEl.innerHTML =
              `<div>
                <strong>la chanson jouée sera la n° ${X}</strong>
                <span class="small"><a class="song-link" href="${escapeHtml(songUrl)}" target="_blank" rel="noopener noreferrer">${escapeHtml(songText)}</a></span>
              </div>`;
          } else if(songText) {
            resultEl.innerHTML =
              `<div>
                <strong>la chanson jouée sera la n° ${X}</strong>
                <span class="small">${escapeHtml(songText)}</span>
              </div>`;
          } else {
            resultEl.textContent = `la chanson jouée sera la n° ${X}`;
          }
        } else {
          resultEl.textContent = `la chanson jouée sera la n° ${X}`;
        }

        isSpinning = false;
        spinBtn.disabled = false;
      };

      requestAnimationFrame(tick);
    }

    function buildBulbs(){
      const bulbsEl = document.getElementById("bulbs");
      bulbsEl.innerHTML = "";
      if(!CONFIG.ENABLE_BULBS) return;

      const count = CONFIG.BULB_COUNT;
      for(let i=0; i<count; i++){
        const b = document.createElement("div");
        b.className = "bulb";
        bulbsEl.appendChild(b);
      }

      const w = bulbsEl.clientWidth || 1;
      const h = bulbsEl.clientHeight || 1;
      const perim = 2*(w+h);

      [...bulbsEl.children].forEach((b, i) => {
        const p = (i / count) * perim;
        let x, y;

        if(p < w){ x = p; y = 0; }
        else if(p < w + h){ x = w; y = p - w; }
        else if(p < 2*w + h){ x = 2*w + h - p; y = h; }
        else { x = 0; y = perim - p; }

        b.style.left = `${x}px`;
        b.style.top = `${y}px`;
      });
    }

    async function init(){
      setThemeVars();
      buildRows();

      SONGS = await loadSongsIfAny();
      nValue = SONGS ? SONGS.length : CONFIG.N;

      refillBag(nValue);

      centerIndexValue = secureRandomInt(nValue);
      renderRows(centerIndexValue, 0);

      buildBulbs();
      window.addEventListener("resize", buildBulbs);

      spinBtn.addEventListener("click", spin);
    }

    init();
  </script>
</body>
</html>
