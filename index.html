<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tirage au sort — Roue verticale</title>
  <style>
    :root{
      /* Les variables CSS sont alimentées par CONFIG via JS */
      --bg: #0b0f1a;
      --panel: rgba(255,255,255,0.06);
      --text: #e9ecff;
      --muted: rgba(233,236,255,0.75);
      --accent: #00e5ff;
      --accent2: #ff2bd6;
      --caseA: rgba(0,229,255,0.18);
      --caseB: rgba(255,43,214,0.18);
      --border: rgba(255,255,255,0.18);

      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --wheelW: 520px;
      --wheelH: 520px;
      --rowH: 44px;
      --rowCount: 11;
    }

    html, body{
      height:100%;
      margin:0;
      font-family: var(--font);
      background: radial-gradient(1200px 700px at 50% 20%, rgba(0,229,255,0.10), transparent 60%),
                  radial-gradient(900px 600px at 70% 70%, rgba(255,43,214,0.10), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .wrap{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 28px 16px;
      box-sizing:border-box;
    }

    .app{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1fr;
      gap: 18px;
      justify-items:center;
    }

    .title{
      font-size: 20px;
      letter-spacing: 0.4px;
      color: var(--muted);
      text-align:center;
    }

    .stage{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      justify-items:center;
    }

    /* Cadre roue */
    .wheel-frame{
      width: var(--wheelW);
      height: var(--wheelH);
      max-width: 100%;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid var(--border);
      box-shadow: 0 12px 40px rgba(0,0,0,0.45);
      position: relative;
      overflow:hidden;
    }

    /* Bonus "80s lights" */
    .lights{
      position:absolute;
      inset: 10px;
      border-radius: 14px;
      pointer-events:none;
      box-shadow:
        0 0 0 2px rgba(255,255,255,0.10),
        0 0 30px rgba(0,229,255,0.10),
        0 0 30px rgba(255,43,214,0.10);
    }

    .bulbs{
      position:absolute;
      inset: 8px;
      border-radius: 14px;
      pointer-events:none;
    }
    .bulb{
      position:absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255,255,255,0.22);
      box-shadow: 0 0 12px rgba(255,255,255,0.20);
      animation: blink 1.1s infinite steps(2,end);
    }
    .bulb:nth-child(3n){ animation-duration: 0.9s; }
    .bulb:nth-child(4n){ animation-duration: 1.3s; }
    @keyframes blink{
      0%{ opacity: 0.35; filter: saturate(1); }
      50%{ opacity: 0.95; filter: saturate(1.6); }
      100%{ opacity: 0.35; filter: saturate(1); }
    }

    /* Fenêtre de la roue */
    .wheel-window{
      position:absolute;
      left: 22px;
      right: 22px;
      top: 22px;
      bottom: 22px;
      border-radius: 14px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
      overflow:hidden;
    }

    /* Bande centrale (highlight) + curseur */
    .center-highlight{
      position:absolute;
      left:0; right:0;
      top: 50%;
      height: var(--rowH);
      transform: translateY(-50%);
      background: linear-gradient(90deg, rgba(0,229,255,0.14), rgba(255,43,214,0.14));
      border-top: 1px solid rgba(255,255,255,0.14);
      border-bottom: 1px solid rgba(255,255,255,0.14);
      box-shadow: inset 0 0 40px rgba(0,0,0,0.25);
      pointer-events:none;
    }

    .pointer{
      position:absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 0;
      height: 0;
      border-top: 14px solid transparent;
      border-bottom: 14px solid transparent;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.35));
      pointer-events:none;
    }
    .pointer.left{
      left: 12px;
      border-right: 20px solid rgba(255,255,255,0.85);
    }
    .pointer.right{
      right: 12px;
      border-left: 20px solid rgba(255,255,255,0.85);
    }

    /* Liste virtualisée */
    .reel{
      position:absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .rows{
      width: 100%;
      padding: 18px 0;
      box-sizing:border-box;
      transform: translateY(0px);
      will-change: transform;
    }

    .row{
      height: var(--rowH);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 18px;
      box-sizing:border-box;
      font-size: 18px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      letter-spacing: 0.2px;
      user-select:none;
    }

    .row:nth-child(odd){ background: var(--caseA); }
    .row:nth-child(even){ background: var(--caseB); }

    .row .num{
      font-variant-numeric: tabular-nums;
      opacity: 0.95;
    }
    .row .label{
      opacity: 0.9;
      text-align:right;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 72%;
      color: var(--muted);
      font-size: 14px;
    }

    /* Contrôles */
    .controls{
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content:center;
      flex-wrap: wrap;
    }

    button{
      appearance:none;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 16px;
      letter-spacing: 0.2px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.35);
      transition: transform 0.08s ease, background 0.15s ease;
    }
    button:hover{ background: rgba(255,255,255,0.11); }
    button:active{ transform: translateY(1px); }
    button:disabled{
      opacity: 0.55;
      cursor:not-allowed;
    }

    .meta{
      font-size: 13px;
      color: var(--muted);
      text-align:center;
      max-width: 860px;
      line-height: 1.45;
    }

    .result{
      width: min(860px, 100%);
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 12px 14px;
      box-sizing:border-box;
      text-align:center;
      min-height: 48px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .result strong{
      color: var(--text);
    }

    .small{
      display:block;
      margin-top: 4px;
      font-size: 13px;
      color: var(--muted);
    }

    /* Layout : image à gauche, roue à droite */
.stage{
  display:grid;
  grid-template-columns: minmax(260px, 420px) 1fr;
  gap: 18px;
  align-items: center;
  justify-items: center;
}

/* Image à gauche */
.left-art{
  width: 100%;
  max-width: 420px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.left-art img{
  width: 100%;
  height: auto;
  display:block;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 12px 40px rgba(0,0,0,0.45);
  object-fit: contain;
}

/* Responsive : sur petit écran, on empile */
@media (max-width: 900px){
  .stage{
    grid-template-columns: 1fr;
  }
  .left-art{
    max-width: 520px;
  }
}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="app">
      <div class="title">Tirage au sort — roue verticale (virtualisée, sans répétition)</div>

      <div class="stage">
        <div class="wheel-frame" id="wheelFrame">
          <div class="lights"></div>
          <div class="bulbs" id="bulbs"></div>

          <div class="wheel-window">
            <div class="reel">
              <div class="rows" id="rows"></div>
            </div>

            <div class="center-highlight"></div>
            <div class="pointer left"></div>
            <div class="pointer right"></div>
          </div>
        </div>

        <div class="controls">
          <button id="spinBtn">Lancer la roue</button>
          <button id="resetBagBtn" title="Remélange le sac (si tu veux repartir de zéro)">Remélanger</button>
        </div>

        <div class="result" id="result">—</div>
        <div class="meta" id="meta"></div>
      </div>
    </div>
  </div>

  <script>
    /*****************************************************************
     * CONFIG — Tous les paramètres regroupés ici
     *****************************************************************/
    const CONFIG = {
      // Si songs.json est présent et valide, N sera ignoré et remplacé par songs.length
      N: 2000,

      // Durée du spin en millisecondes (paramétrable en dur)
      SPIN_DURATION_MS: 5000,

      // Nombre de lignes visibles (impair, pour avoir un centre)
      VISIBLE_ROWS: 11,

      // Hauteur d’une ligne en pixels (doit matcher le CSS --rowH)
      ROW_HEIGHT_PX: 44,

      // Contrôle du "ressenti" : nombre de pas visuels minimum/maximum
      // (ce ne sont pas des "chansons", juste des crans d’animation)
      BASE_STEPS_MIN: 120,
      BASE_STEPS_MAX: 190,

      // Thème
      THEME: {
        bg: "#0b0f1a",
        text: "#e9ecff",
        muted: "rgba(233,236,255,0.75)",
        accent: "#00e5ff",
        accent2: "#ff2bd6",
        caseA: "rgba(0,229,255,0.18)",
        caseB: "rgba(255,43,214,0.18)",
        border: "rgba(255,255,255,0.18)",
        font: "system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif",
        wheelW: "520px",
        wheelH: "520px"
      },

      // Bonus 80s : lumières
      ENABLE_BULBS: true,
      BULB_COUNT: 44, // autour du cadre
    };

    /*****************************************************************
     * Utilitaires
     *****************************************************************/
    function setThemeVars() {
      const t = CONFIG.THEME;
      const r = document.documentElement.style;
      r.setProperty("--bg", t.bg);
      r.setProperty("--text", t.text);
      r.setProperty("--muted", t.muted);
      r.setProperty("--accent", t.accent);
      r.setProperty("--accent2", t.accent2);
      r.setProperty("--caseA", t.caseA);
      r.setProperty("--caseB", t.caseB);
      r.setProperty("--border", t.border);
      r.setProperty("--font", t.font);
      r.setProperty("--wheelW", t.wheelW);
      r.setProperty("--wheelH", t.wheelH);

      r.setProperty("--rowH", CONFIG.ROW_HEIGHT_PX + "px");
      r.setProperty("--rowCount", CONFIG.VISIBLE_ROWS);
    }

    function easeOutCubic(x) {
      return 1 - Math.pow(1 - x, 3);
    }

    function clamp01(x){ return Math.max(0, Math.min(1, x)); }

    function secureRandomInt(maxExclusive){
      // Tirage uniforme via crypto
      const arr = new Uint32Array(1);
      const limit = Math.floor(0xFFFFFFFF / maxExclusive) * maxExclusive;
      while(true){
        crypto.getRandomValues(arr);
        const v = arr[0];
        if(v < limit) return v % maxExclusive;
      }
    }

    function fisherYatesShuffle(a){
      for(let i=a.length-1; i>0; i--){
        const j = secureRandomInt(i+1);
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    /*****************************************************************
     * Données chansons (optionnel)
     *****************************************************************/
    let SONGS = null; // soit array de strings, soit array d'objets {title, artist}
    async function loadSongsIfAny(){
      try{
        const res = await fetch("./songs.json", { cache: "no-store" });
        if(!res.ok) return null;
        const data = await res.json();
        if(!Array.isArray(data) || data.length === 0) return null;

        // Validation minimale
        if(typeof data[0] === "string") return data;
        if(typeof data[0] === "object" && data[0] && ("title" in data[0] || "artist" in data[0])) return data;

        return null;
      } catch {
        return null;
      }
    }

    function formatSong(entry){
      if(entry == null) return null;
      if(typeof entry === "string") return entry;
      const title = entry.title ?? "Titre inconnu";
      const artist = entry.artist ? " — " + entry.artist : "";
      return title + artist;
    }

    /*****************************************************************
     * Mécanique "sans répétition" (sac mélangé)
     *****************************************************************/
    let bag = [];
    let bagIndex = 0;

    function refillBag(n){
      bag = Array.from({length:n}, (_,i)=>i); // indices 0..n-1
      fisherYatesShuffle(bag);
      bagIndex = 0;
    }

    function drawUniqueIndex(n){
      if(bag.length !== n || bagIndex >= bag.length){
        refillBag(n);
      }
      const v = bag[bagIndex];
      bagIndex++;
      return v;
    }

    /*****************************************************************
     * Rendu roue virtualisée
     *****************************************************************/
    const rowsEl = document.getElementById("rows");
    const spinBtn = document.getElementById("spinBtn");
    const resetBagBtn = document.getElementById("resetBagBtn");
    const resultEl = document.getElementById("result");
    const metaEl = document.getElementById("meta");

    const centerSlot = Math.floor(CONFIG.VISIBLE_ROWS / 2);

    // État de position
    // centerIndex = indice (0..n-1) affiché au centre
    let nValue = CONFIG.N;
    let centerIndexValue = 0;

    // Pour animation : position absolue en "steps" (pas)
    // Chaque step fait avancer d’une case.
    let absoluteStep = 0; // entier
    let isSpinning = false;

    function buildRows(){
      rowsEl.innerHTML = "";
      for(let i=0; i<CONFIG.VISIBLE_ROWS; i++){
        const row = document.createElement("div");
        row.className = "row";

        const num = document.createElement("div");
        num.className = "num";

        const label = document.createElement("div");
        label.className = "label";

        row.appendChild(num);
        row.appendChild(label);
        rowsEl.appendChild(row);
      }
    }

    function renderRows(centerIndex, fractionalOffset){
      // fractionalOffset in [0,1) : translateY(-fractionalOffset * rowH)
      rowsEl.style.transform = `translateY(${-fractionalOffset * CONFIG.ROW_HEIGHT_PX}px)`;

      const rowNodes = rowsEl.children;
      for(let i=0; i<rowNodes.length; i++){
        const logicalIndex = mod(centerIndex + (i - centerSlot), nValue);
        const displayNumber = logicalIndex + 1;

        const row = rowNodes[i];
        row.querySelector(".num").textContent = displayNumber;

        const label = row.querySelector(".label");
        if(SONGS){
          label.textContent = formatSong(SONGS[logicalIndex]);
        } else {
          label.textContent = "";
        }
      }
    }

    function mod(a, m){
      return ((a % m) + m) % m;
    }

    /*****************************************************************
     * Animation : on tire X d'abord, puis on anime jusqu’à X
     *****************************************************************/
    function computeTotalStepsToLandOn(targetIndex){
      // On veut que (centerIndexValue + totalSteps) % nValue === targetIndex
      const delta = mod(targetIndex - centerIndexValue, nValue);

      // BaseSteps pour le "ressenti"
      const baseSteps = CONFIG.BASE_STEPS_MIN + secureRandomInt(CONFIG.BASE_STEPS_MAX - CONFIG.BASE_STEPS_MIN + 1);

      // Ajustement pour tomber exactement sur delta
      const adjust = mod(delta - (baseSteps % nValue), nValue);
      return baseSteps + adjust;
    }

    async function spin(){
      if(isSpinning) return;
      isSpinning = true;
      spinBtn.disabled = true;

      // Tirage sans répétition (index 0..n-1)
      const targetIndex = drawUniqueIndex(nValue);
      const totalSteps = computeTotalStepsToLandOn(targetIndex);

      const startAbsolute = absoluteStep;
      const startTime = performance.now();
      const duration = CONFIG.SPIN_DURATION_MS;

      // Frame loop
      const tick = (now) => {
        const t = clamp01((now - startTime) / duration);
        const eased = easeOutCubic(t);

        const stepsFloat = totalSteps * eased; // 0 -> totalSteps
        const stepsInt = Math.floor(stepsFloat);
        const frac = stepsFloat - stepsInt;

        // Centre = centre initial + stepsInt
        const center = mod(centerIndexValue + stepsInt, nValue);
        renderRows(center, frac);

        if(t < 1){
          requestAnimationFrame(tick);
          return;
        }

        // Fin : alignement parfait sur une case (frac=0)
        absoluteStep = startAbsolute + totalSteps;
        centerIndexValue = mod(centerIndexValue + totalSteps, nValue);
        renderRows(centerIndexValue, 0);

        const X = centerIndexValue + 1;
        const songText = SONGS ? formatSong(SONGS[centerIndexValue]) : null;

        if(songText){
          resultEl.innerHTML = `<div><strong>la chanson jouée sera la n° ${X}</strong><span class="small">${escapeHtml(songText)}</span></div>`;
        } else {
          resultEl.textContent = `la chanson jouée sera la n° ${X}`;
        }

        isSpinning = false;
        spinBtn.disabled = false;
      };

      requestAnimationFrame(tick);
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /*****************************************************************
     * Bonus 80s bulbs
     *****************************************************************/
    function buildBulbs(){
      const bulbsEl = document.getElementById("bulbs");
      bulbsEl.innerHTML = "";
      if(!CONFIG.ENABLE_BULBS) return;

      const count = CONFIG.BULB_COUNT;
      for(let i=0; i<count; i++){
        const b = document.createElement("div");
        b.className = "bulb";
        bulbsEl.appendChild(b);
      }

      // Positionnement simple en "cadre" (réparti sur le pourtour)
      // On place les ampoules le long du rectangle en parcourant le périmètre normalisé.
      const w = bulbsEl.clientWidth || 1;
      const h = bulbsEl.clientHeight || 1;
      const perim = 2*(w+h);

      [...bulbsEl.children].forEach((b, i) => {
        const p = (i / count) * perim;
        let x, y;

        if(p < w){ x = p; y = 0; }
        else if(p < w + h){ x = w; y = p - w; }
        else if(p < 2*w + h){ x = 2*w + h - p; y = h; }
        else { x = 0; y = perim - p; }

        b.style.left = `${x}px`;
        b.style.top = `${y}px`;
      });
    }

    /*****************************************************************
     * Init
     *****************************************************************/
    async function init(){
      setThemeVars();
      buildRows();

      // Essaye de charger songs.json
      SONGS = await loadSongsIfAny();
      if(SONGS){
        nValue = SONGS.length;
        metaEl.textContent = `Mode chansons : ${nValue} titres (tirage sans répétition).`;
      } else {
        nValue = CONFIG.N;
        metaEl.textContent = `Mode numérique : n = ${nValue} (tirage sans répétition).`;
      }

      // Sac initial
      refillBag(nValue);

      // Position de départ aléatoire (optionnel)
      centerIndexValue = secureRandomInt(nValue);
      renderRows(centerIndexValue, 0);

      // Bulbs (après layout)
      buildBulbs();
      window.addEventListener("resize", buildBulbs);

      spinBtn.addEventListener("click", spin);
      resetBagBtn.addEventListener("click", () => {
        refillBag(nValue);
        resultEl.textContent = "—";
      });
    }

    init();
  </script>
</body>
</html>
